# RTOS面试合集

## 啥是RTOS

​	RTOS的英文全称是Real Time Operating System.也就是实时操作系统。**实时操作系统重点在于实时两个字**，说明他更加注重实时性。一般的，我们会说，实时操作系统有效的屏蔽了我们负责复杂的并行任务调度的需求，只需要用API就OK了。就可以让很多事情看起来在同一时刻做。这个效果就是并发。

1. **确定性**：任务响应时间可预测，确保在规定时间内完成。
2. **多任务处理**：支持多任务并发，任务调度基于优先级。
3. **任务调度**：采用实时调度算法，如优先级调度、轮转调度等。
4. **中断处理**：快速响应外部事件，中断延迟低。
5. **资源管理**：高效管理CPU、内存等资源，避免资源竞争。
6. **实时时钟**：提供高精度时钟，支持定时任务和事件。

### 进程的状态

​	这属于操作系统的范畴：进程有四种常见的状态。

- 就绪（Ready）：任务可以执行，但等待调度器分配CPU。
- 运行中（Running）：任务当前正在使用CPU执行。
- 阻塞（Blocked）：任务等待某个事件（如信号量、消息队列）发生。
- 挂起（Suspended）：任务被挂起，不会被调度。

​	他将每一个执行的函数封装成为一个任务。一个任务，或者说一个进程，需要有地方施展身手，记住自身。这就是任务堆栈。RTOS为每个任务分配独立的堆栈空间，用于存储任务的局部变量、函数调用信息和上下文数据（如寄存器）。**在上下文切换时，RTOS保存当前任务的堆栈指针，切换到下一个任务时，恢复其堆栈指针，以保持任务独立运行**。

​	**上下文切换是指在多任务环境中，从当前执行的任务切换到另一个任务执行的过程。上下文切换包括保存当前任务的CPU状态（如寄存器、程序计数器），以及加载即将运行任务的CPU状态。这是多任务操作系统中实现任务并行的核心机制。**上下文切换让进程从运行中变为就绪，换上另一个任务继续跑。

### RTOS的调度

​	RTOS是优先级调度的。优先级调度是根据任务的优先级选择哪个任务运行的调度策略。RTOS根据每个任务的优先级值进行排序，**优先运行优先级高的任务。当更高优先级的任务变为就绪态时，调度器会立即抢占当前正在运行的低优先级任务。**

#### 什么是时间片轮转调度？ 

​	时间片轮转调度是一种非抢占式调度方法，**将CPU时间分成若干时间片，每个就绪任务依次获得一个时间片来执行。当任务的时间片用完后，调度器会切换到下一个任务执行，直到所有任务完成其时间片后再循环执行。这种方式适用于优先级相同的任务调度。**

#### 如何实现基于优先级的抢占调度？ 

​	基于优先级的抢占调度是指当一个高优先级任务变为就绪态时，立即中断当前正在执行的低优先级任务，切换到高优先级任务执行。实现方法是调度器持续监控就绪队列，当有更高优先级的任务可运行时，执行上下文切换以运行该任务。

#### 任务调度中的“时间窗”概念是什么？ 

时间窗是指在任务调度中，每个任务获得CPU执行时间的固定或可变时间段。它确保任务在特定时间内完成执行。实时系统中，时间窗有助于保证任务在规定的时间内被调度，以满足系统的实时性需求。

### 任务和线程

​	在RTOS中，任务和线程本质上是相同的概念，都是独立的执行单元。两者的区别主要在于语义：
- 任务：通常指具有更高层次功能的程序，包含多个子操作。任务是一个完整的工作单位。
- 线程：指在任务内部的一条执行路径，多个线程可以共享同一任务的资源。
- 在RTOS中，这两者都包含有自己的堆栈和上下文，可以独立调度。

#### 如何在RTOS中创建和删除任务？ 

​	创建和删除任务通常通过RTOS提供的API来实现。创建任务的步骤包括：

- 分配任务堆栈。
- 定义任务入口函数。
- 设置任务的优先级和初始状态（如就绪状态）。
- 通过系统调用（如create_task）注册任务。
- 删除任务时，RTOS会释放任务的堆栈和其他相关资源，并通过调用delete_task移除任务。

#### 任务间如何共享数据？ 

任务之间共享数据的常见方法有三种：

- 共享内存：**多个任务可以访问同一块内存，但需要同步机制（如信号量或互斥量）避免数据竞争。**
- 消息队列：任务通过发送和接收消息在队列中共享数据，适用于任务间的异步通信。
- 事件标志组：通过事件标志触发数据共享或同步多个任务。

#### 如何管理任务的生命周期？ 

- 创建：通过API初始化任务资源（如堆栈）并将其加入调度器管理。
- 运行：调度器根据优先级分配CPU给任务执行。
- 阻塞/挂起：任务等待资源或事件时被阻塞或挂起，直到条件满足。
- 删除/销毁：任务完成工作后，释放任务相关的资源并从调度

### 中断

​	中断的概念可以参考操作系统或者是微机原理的教材。实质上就是打断现在做的事情去处理中断要求的事情。比如说，你的电脑响应键盘或者是鼠标事件就是依赖于设备产生的中断，操作系统收到硬件指示的中断做callback回应。

​	更官方的说：中断是硬件或软件引发的信号，通知CPU立即停止当前工作并执行中断服务例程（ISR）。中断发生时，当前任务的状态被保存，CPU转移到中断处理代码执行，处理完成后恢复任务继续运行。中断机制用于处理紧急事件。

​	受理中断本身为中断服务例程（ISR），它的特点是：

- 快！必须要快，不然容易丢失中断
- 不可以被调度，他只接受中断回调Callback调用
- ISR也是有等级的，优先处理优先级高的中断

​	嵌套中断是指在一个中断处理过程中允许另一个优先级更高的中断打断当前的ISR执行。CPU会优先处理高优先级中断，完成后再继续处理被打断的中断。嵌套中断提高了系统对高优先级事件的响应能力。

### 优先级反转

#### 优先级反转发生条件

1. **任务优先级不同**：系统中存在高、中、低三个不同优先级的任务。
2. **资源共享**：低优先级任务持有高优先级任务所需的资源（如互斥锁）。
3. **资源竞争**：高优先级任务因资源被占用而阻塞，中优先级任务得以运行。

举个例子，假设有三个任务：

- **任务A**：高优先级
- **任务B**：中优先级
- **任务C**：低优先级

1. **任务C**获得资源并开始执行。
2. **任务A**请求同一资源，但因被**任务C**占用而阻塞。
3. **任务B**开始执行，因为它优先级高于**任务C**，但低于**任务A**。
4. **任务C**无法继续执行，导致**任务A**长时间阻塞

​	你看，这样就发生了优先级反转的问题！

​	解决的办法是**优先级继承或优先级天花板机制来防止中断中的优先级反转。**在优先级继承机制中，持有资源的低优先级任务会暂时提升其优先级以匹配阻塞它的高优先级任务，直到资源释放，避免高优先级任务被阻塞。

- 优先级继承：当高优先级任务因持有资源的低优先级任务被阻塞时，低优先级任务会“继承”高优先级任务的优先级，直到资源释放，防止优先级反转。
- 优先级天花板：每个共享资源都有一个最高优先级（天花板）。当任务获取资源时，其优先级会暂时提升到资源的天花板级别，防止低优先级任务在资源释放之前被高优先级任务抢占

### RTOS的通信

​	消息队列是一种任务间通信机制，允许任务通过**发送和接收消息来交换数据**。消息按先进先出的顺序存储在队列中，任务通过send和receive接口进行通信。消息队列实现任务的解耦，允许任务异步工作，且避免了直接访问共享数据的复杂性。也就是说，消息队列取消了我们关心如何完成两者对接信息的必要性，直接使用API发发收收就OK了。

#### 信号量和互斥量

- 信号量：用于任务之间的同步或资源计数，允许多个任务访问同一资源。计数信号量可以表示多个资源的可用性。
- 互斥量：用于保护共享资源的互斥访问，确保同一时刻只有一个任务能访问资源，防止竞争条件。互斥量还常用于避免优先级反转问题。

### 移植与适应 

#### 移植RTOS到新硬件时需要考虑哪些因素？ 

​	一般而言，我们会在相同架构上移植。有时候可能是ARM转RISC-V或者反过来，那么就需要考虑指令集，寄存器，内存模型等的差异，想下自己的项目有没有跟架构硬耦合，需要做抽象！之后的事情就是：

- CPU架构：不同的指令集、寄存器模型和内存模型。
- 中断控制：确保RTOS正确处理硬件的中断机制。
- 时钟源和计时器：RTOS依赖时钟进行任务调度和计时。
- 硬件驱动程序：为新硬件编写必要的驱动程序，如I/O、网络接口等。

#### 如何确保RTOS的性能？ 

- 优化上下文切换时间：减少上下文切换的开销。
- 精简中断处理路径：确保中断的快速响应。
- 优化内存管理：合理分配堆栈和堆内存，避免内存碎片。
- 使用硬件加速：充分利用硬件支持的加速机制（如DMA、缓存等）。

#### 如何识别和消除任务中的瓶颈？ 

- 使用性能分析工具：分析CPU利用率、上下文切换次数、中断延迟等指标。
- 任务跟踪工具：跟踪任务的执行顺序和时间，识别耗时的任务或函数。
- 优化任务逻辑：减少不必要的阻塞操作或任务切换，提升任务效率。

#### 任务堆栈大小如何优化？ 

- 堆栈分析工具：利用RTOS的堆栈监测工具分析每个任务的最大堆栈使用量。
- 任务分解：将耗费堆栈的任务拆分为多个子任务，以减少单个任务的堆栈需求。换而言之，不要一大堆东西堆在一个任务里，笔者记得一个说法：当一个函数超过了40行，需要想下自己是不是可以分解更为细碎的逻辑！（使用宏都行）
- 减少局部变量的使用：避免在任务中声明大规模局部变量，改用全局变量或动态内存分配。

### 资源管理

​	操作系统的一个重量级任务就是资源管理。比如说内存，CPU的使用和对外设的控制等等。

#### 内存

- 静态内存分配：在编译时分配固定大小的内存，适用于资源受限的系统，减少动态分配的复杂性和开销。
- 动态内存分配：在运行时使用malloc或类似函数按需分配内存。RTOS提供了内存管理模块，如内存池或堆管理器，来应对动态内存分配。内存池将内存划分为固定大小的块，提高分配效率并减少碎片。

#### 内存泄漏

- 如果场景极端固定，不妨使用静态内存
- 及时释放内存：动态分配的内存应在任务完成后及时释放。也就是谁开辟，谁释放。
- 内存监控工具：使用内存监控工具定期检测内存使用情况，发现未释放的内存。
- 良好的编程习惯：确保每次malloc（或类似函数）的分配都对应free，并避免过度使用全局变量。

#### 电源管理

- 低功耗模式：RTOS可以进入低功耗状态，如休眠模式或深度睡眠模式，任务空闲时节省电能。
- 动态电源管理：根据系统负载动态调整处理器频率和电压，降低能耗。
- 设备电源控制：管理外设的供电状态，当外设不需要时关闭或休眠，进一步节省能源

#### 资源请求问题

##### 死锁

死锁是指多个任务互相等待彼此释放资源，导致系统停滞不前。避免死锁的方法包括：

- 资源有序分配：任务按照固定顺序请求资源，防止循环等待。
- 使用超时机制：设置资源获取的超时时间，超时后放弃资源请求，避免死锁。
- 死锁检测算法：周期性检查系统是否存在死锁，并通过回滚或资源释放解除死锁。

##### 定时器

- 硬件定时器：依赖于硬件时钟，通过定时器中断触发特定的操作。定时器中断发生后，RTOS将调用定时器回调函数或唤醒等待的任务。
- 软件定时器：通过定时任务周期性检查系统时间，执行到期任务。RTOS为每个定时器设置回调函数，定时到期时执行相应操作。